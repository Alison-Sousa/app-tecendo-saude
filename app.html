<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Tecendo Sa√∫de</title>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* DESIGN SYSTEM */
  :root { --primary: #15803d; --bg: #f0fdf4; --text: #0f172a; }
  body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text); margin: 0; -webkit-tap-highlight-color: transparent; }

  /* Anima√ß√µes */
  .fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* Bot√µes */
  .btn-primary {
    width: 100%; padding: 18px; background: linear-gradient(135deg, #16a34a 0%, #14532d 100%);
    color: #fff; border-radius: 14px; font-weight: 800; font-size: 16px; border: none; cursor: pointer;
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4); display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn-primary:active { transform: scale(0.98); box-shadow: none; }

  .btn-sec {
    width: 100%; padding: 14px; background: #fff; color: #475569; border: 1px solid #cbd5e1;
    border-radius: 14px; font-weight: 700; cursor: pointer;
  }

  /* Inputs */
  .input-box, select, textarea {
    width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #cbd5e1;
    background: #fff; font-size: 16px; outline: none; margin-bottom: 12px; appearance: none;
  }
  .input-box:focus { border-color: var(--primary); ring: 2px solid #bbf7d0; }

  /* Cards */
  .card { background: #fff; padding: 16px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 12px; border: 1px solid #f1f5f9; }
  
  /* Badges */
  .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
  .badge-pendente { background: #fee2e2; color: #991b1b; }
  .badge-ok { background: #dcfce7; color: #166534; }

  /* M√≠dia Buttons */
  .media-row { display: flex; gap: 8px; margin-bottom: 16px; }
  .btn-media {
    flex: 1; padding: 12px; background: #f8fafc; border-radius: 12px; border: 2px solid transparent;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: #64748b; cursor: pointer; position: relative; overflow: hidden;
  }
  .btn-media.active { background: #dcfce7; border-color: #16a34a; color: #166534; }
  .hidden-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 10; }

  /* Utils */
  .section-title { font-size: 13px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin: 24px 0 8px 0; letter-spacing: 1px; }
  .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: 700; color: var(--primary); }
  .sync-float { position: fixed; bottom: 20px; right: 20px; background: #0f172a; color: #fff; padding: 8px 16px; border-radius: 30px; font-size: 11px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  
  /* Thumbnails */
  .thumb { width: 60px; height: 60px; border-radius: 8px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; font-size: 24px; cursor: pointer; }
  
  /* Dashboard Pro Buttons */
  .big-btn {
    width: 100%; padding: 30px; background: #fff; border-radius: 20px; border: 1px solid #e2e8f0;
    display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer;
    box-shadow: 0 4px 6px -2px rgba(0,0,0,0.02); margin-bottom: 16px;
  }
  .big-btn-icon { font-size: 32px; background: #dcfce7; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

// 1. CONFIGURA√á√ÉO SUPABASE
const SUPABASE_URL = 'https://rucpqwojmgnqibeskaaj.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_sBflW42mIzVo835NoMrsjw_uYvlCR8z';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const {useState,useEffect,useRef,useMemo,useCallback}=React;

const db = new Dexie('TecendoSaudeDB_V22_Fixed');
// v1 j√° existia sem foto_url; v2 adiciona foto_url
db.version(1).stores({
  perfil:'++id,patientId,synced, nome, cpf, nascimento, regiao, ubs_referencia, genero, raca, endereco, telefone, escolaridade, profissao, mora_sozinho, acs_responsavel, hipertensao, diabetes, vicios, tempo_vicio, altura, peso_inicial, enxerga_bem, consulta_oftalmo, uso_medicacoes, atividade_fisica, freq_atividade, tipo_atividade, meta_peso, meta_glicemia, meta_pa_min, meta_pa_max',
  registros:'++id,registroId,patientId,deviceId,createdAt,updatedAt,status,synced',
  midias:'++id,registroId,name,type,synced'
});
db.version(2).stores({
  perfil:'++id,patientId,synced, nome, cpf, nascimento, regiao, foto_url, ubs_referencia, genero, raca, endereco, telefone, escolaridade, profissao, mora_sozinho, acs_responsavel, hipertensao, diabetes, vicios, tempo_vicio, altura, peso_inicial, enxerga_bem, consulta_oftalmo, uso_medicacoes, atividade_fisica, freq_atividade, tipo_atividade, meta_peso, meta_glicemia, meta_pa_min, meta_pa_max',
  registros:'++id,registroId,patientId,deviceId,createdAt,updatedAt,status,synced',
  midias:'++id,registroId,name,type,synced'
}).upgrade(tx => {
  // preencher foto_url vazio
  return tx.table('perfil').toCollection().modify(p => { if(!p.foto_url) p.foto_url = ''; });
});

// 2. DADOS
const LISTA_UBS = ["UBS Ant√¥nio Evangelista", "UBS Boa Esperan√ßa", "UBS Divin√≥polis", "UBS M√°rcio Marinho", "UBS Haroldo Martins", "UBS Maria Bibiana da Silva", "UBS Nadime Miranda", "UBS Neli Loeblein", "UBS Vicente Alves da Silva"];
const LISTA_REGIOES = ["Santar√©m", "Belterra", "Moju√≠ dos Campos", "Alenquer", "Curu√°", "√ìbidos", "Oriximin√°", "Terra Santa", "Faro", "Juruti", "Monte Alegre", "Almeirim", "Prainha"];
const LISTA_ACS = ["Acsa Kelly Gelio de S√° Lucena","Adriano Grings de Abreu","Cleonice Fabiano","Cleudes Meireles do Prado","Daniella de Almeida Santos","Edv√¢nia Barbosa Sousa","Eliane Sousa Matos","Eliselma Alves Barreto","Eliz√¢ngela Guedes Moura","√ârica Sousa Scalabrim","Erika Sousa Duarte","Francisca Deneide Fran√ßa da Silva","Glaucione Santos Brito","Lourdes Dallabrida Rech","Luzineide Brito dos Santos","Marisane Aparecida Facioni","Paulo Afonso Borges da Silva","Raimunda de Souza Brand√£o","Robson Lima de Oliveira","Silvana Cardoso Ott","Silvana de Sousa Silva","Silvana Ferreira de Almeida","V√¢nea Pereira Scalabrin","Antonio Benigno de Freita","Antonio Pereira Correa","Auzenira Carvalho Cunha","C√©lia Alves Cruz","Elzana Lopes de Castro","Eudilene Vitor Gomes Matos","Evando Oliveira Santos","Fabiana Gomes Peixoto","Geizeane Maria das G. Sales","Genival Rodrigues Marinho","Hosana Lopes de Castro","Josias Martins de Oliveira","L√©ia de Souza Alves","Maria da Concei√ß√£o dos Santos Ribeiro","Maria de Andrade Lima","Maria Elismar Bezerra Barbosa","Rita Delmondes Ferreira","Valdemir Machado de Alegor","Alzilene Braga","Ariane do Nascimento da Silva","Claudil√©ia de Sousa Castro","Edi Alves de Barros","Elaine Soares de Sousa","Ivanete Teixeira Silva","Ivonete Henz","Natividade Pereira de Aguiar","Regilene Hecki da Costa","Jackeline Paiva Batista","Juliana Lisboa","Aucineia Moreira Galv√£o","Edic√≠nia Rabelo Lourido","Katya Cruz de Sousa","Regiane Lira da Silva","Cl√°udio Jos√© Gon√ßalves Marques","Elinete Cunha de Sousa","Hiranildes Ramos Pereira","Joelma Costa Castro","Jos√© Antonio Sousa de Menezes","Manoel Edinaldo Rodrigues Oliveira","M√°rcio Jos√© Oliveira Figueira","Maria de Lourdes Pinto Costa","Maria Selma Figueira Costa","Mariane Ferreira Castro","Nelma Isabel Marinho Figueira","Orlandino Manoel dos Santos Costa","Vaneila de Siqueira Gamboa","Claudenira Pena Viegas","Jacymar Silva de Brito","Maria Gracinete Lima Fr√≥es","Mariza Dami√£o Lopes","Ana C√©lia de Oliveira","Benedita Walderene Lima da Silva","Dineia da Paix√£o Perna","Dirley de Souza Pedroso","Ednaldo V√°s da Gama","Gabrielle Pinheiro Serr√£o","Gracilene dos Santos","Jucinalda Coelho da Fonseca","Luis Fernando Costa Leite","Manoel Abreu","Maria Ivanete Sarraff dos Santos","Nora Santana dos Santos","Raisa das Gra√ßas Castro","Sediney Dias Marques","Wangela Paiva Batista","Cristiane Palheta da Cruz","Dorival da Concei√ß√£o Oliveira da Silva","Jailma Santos de Sousa","Manoel de Jesus Lima Medeiros","Manoel Rock Batista","Maria da Concei√ß√£o Serra Sarges","Maria das Gra√ßas Pereira Cruz","Maria Sofia Ferreira Lacerda","Noelma Santos de Sousa","Sabrina Gonzaga de Jesus","Zilvanildo Rodrigues Castro"].sort();

const mascaraCPF = v => v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})/,'$1-$2').replace(/(-\d{2})\d+?$/,'$1');
const mascaraData = v => v.replace(/\D/g,'').replace(/(\d{2})(\d)/,'$1/$2').replace(/(\d{2})(\d)/,'$1/$2').replace(/(\d{4})\d+?$/,'$1');
const mascaraTelefone = v => {
  const nums = v.replace(/\D/g,'');
  if(nums.length <= 10) return nums.replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{4})(\d)/,'$1-$2');
  return nums.replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d)/,'$1-$2').replace(/(\d{4})\d+?$/,'$1');
};
const calcAge = d => { if(!d) return ''; const y = d.split('/').reverse().join('-'); const diff = Date.now() - new Date(y).getTime(); return Math.floor(diff/(31557600000)) + ' anos'; };
function formatDateISO(iso){try{return new Date(iso).toLocaleString('pt-BR')}catch(e){return iso||''}}
function uuidv4(){return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}
const fileToDataUrl = (file)=> new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });

// 3. SYNC ENGINE
async function syncManager() {
  if (!navigator.onLine) return;
  try {
    const PERFIL_SYNC_COLUMNS = [
      'patient_id','nome','cpf','nascimento','regiao','foto_url','ubs_referencia','genero','raca','endereco',
      'telefone','escolaridade','profissao','mora_sozinho','acs_responsavel','hipertensao','diabetes','vicios',
      'tempo_vicio','altura','peso_inicial','enxerga_bem','consulta_oftalmo','uso_medicacoes','atividade_fisica',
      'freq_atividade','tipo_atividade','meta_peso','meta_glicemia','meta_pa_min','meta_pa_max'
    ];
    const perfis = await db.perfil.where('synced').equals(0).toArray();
    for (const p of perfis) {
      const { id, synced, patientId, ...rest } = p;
      const base = { patient_id: patientId || ('local-'+id) };
      PERFIL_SYNC_COLUMNS.forEach(k => {
        const keyLocal = k === 'patient_id' ? 'patientId' : k;
        if (keyLocal in rest && rest[keyLocal] !== '' && rest[keyLocal] != null) {
          base[k] = rest[keyLocal];
        }
      });
      if (base.cpf) base.cpf = String(base.cpf).replace(/\D/g,'');
      const nowIso = new Date().toISOString();
      if (!rest.created_at) base.created_at = nowIso;
      base.updated_at = nowIso;
      await supabase.from('perfis').upsert(base, { onConflict: 'patient_id' });
      await db.perfil.update(p.id, { synced: 1 });
    }

    const regs = await db.registros.where('synced').equals(0).toArray();
    for (const r of regs) {
      await supabase.from('registros').upsert({
        registro_id: r.registroId,
        patient_id: r.patientId,
        device_id: r.deviceId,
        texto: r.texto,
        tipo: r.tipo,
        status: r.status,
        replies_json: r.replies || [],
        created_at: r.createdAt,
        updated_at: r.updatedAt
      }, { onConflict: 'registro_id' });
      await db.registros.update(r.id, { synced: 1 });
    }

    const mids = await db.midias.where('synced').equals(0).toArray();
    for (const m of mids) {
      const fileName = `${m.registroId}/${m.name.replace(/[^a-zA-Z0-9.]/g,'_')}`;
      await supabase.storage.from('midias').upload(fileName, m.blob || m.blob, { upsert: true });
      await db.midias.update(m.id, { synced: 1 });
    }
  } catch (e) { /* silenciar erros de sync */ }
}

const SyncIndicator = () => {
  const [p, setP] = useState(0);
  useEffect(() => {
    const loop = setInterval(async () => {
      const c1 = await db.registros.where('synced').equals(0).count();
      const c2 = await db.midias.where('synced').equals(0).count();
      setP(c1 + c2);
      if(navigator.onLine && (c1+c2)>0) syncManager();
    }, 5000);
    return () => clearInterval(loop);
  }, []);
  if(p === 0) return null;
  return <div className="sync-float"><div className="dot-pulse"></div> Sincronizando {p}...</div>;
}

const Loading = ({text}) => <div className="loading"><div className="text-4xl mb-4">üåø</div><div>{text}</div></div>;

// Modal para expandir m√≠dia em tela cheia
const MediaModal = ({url, type, onClose}) => {
  return (
    <div className="modal-bg" onClick={onClose} style={{zIndex: 9999}}>
      <div className="flex flex-col items-center justify-center min-h-screen p-4" onClick={e=>e.stopPropagation()}>
        <div className="bg-white rounded-2xl p-4 max-w-4xl w-full max-h-[90vh] overflow-auto shadow-2xl">
          <div className="flex justify-end mb-3">
            <button className="btn-sec w-auto px-6 py-2 text-sm font-bold" onClick={onClose}>‚úï Fechar</button>
          </div>
          {(type === 'image' || type?.startsWith('image') || !type) && <img src={url} alt="m√≠dia" className="w-full rounded-lg" />}
          {(type === 'video' || type?.startsWith('video') || type === 'video/mp4') && (
            <video controls src={url} className="w-full rounded-lg bg-black" autoPlay style={{maxHeight: '70vh'}} />
          )}
          {(type === 'audio' || type?.startsWith('audio')) && (
            <div className="p-10 text-center">
              <div className="text-6xl mb-4">üéµ</div>
              <audio controls src={url} className="w-full" autoPlay />
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// Thumbnail para registros do paciente
const RegistroThumb = ({registroId}) => {
  const [url, setUrl] = useState('');
  const urlRef = useRef('');
  useEffect(() => {
    let active = true;
    if(urlRef.current){ URL.revokeObjectURL(urlRef.current); urlRef.current=''; }
    setUrl('');
    (async () => {
      const media = await db.midias.where('registroId').equals(registroId).toArray();
      const first = media.find(m => m.type?.startsWith('image')) || media[0];
      if(first && active){
        const objectUrl = URL.createObjectURL(first.blob || first.blob);
        urlRef.current = objectUrl;
        setUrl(objectUrl);
      }
    })();
    return () => {
      active = false;
      if(urlRef.current){ URL.revokeObjectURL(urlRef.current); urlRef.current=''; }
    };
  }, [registroId]);
  if(!url) return <div className="thumb">üìÑ</div>;
  return <img src={url} className="thumb" alt="registro" />;
};

// Componente para mostrar todas as m√≠dias de um registro
const MediasDoRegistro = ({registroId, onMediaClick}) => {
  const [medias, setMedias] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let active = true;
    let objectUrls = [];
    
    const loadMedias = async () => {
      setLoading(true);
      try {
        const mediaList = [];
        
        // 1. Buscar LOCALMENTE (IndexedDB) - PRIORIT√ÅRIO
        const localMedias = await db.midias.where('registroId').equals(registroId).toArray();
        if(localMedias && localMedias.length > 0) {
          for(const m of localMedias) {
            const objectUrl = URL.createObjectURL(m.blob);
            objectUrls.push(objectUrl);
            let type = 'image';
            if(m.type?.startsWith('video')) type = 'video';
            else if(m.type?.startsWith('audio')) type = 'audio';
            mediaList.push({ url: objectUrl, type, name: m.name, source: 'local' });
          }
        }
        
        // 2. Buscar no SUPABASE (se n√£o achou local ou est√° online)
        if(mediaList.length === 0 && navigator.onLine) {
          const { data: files } = await supabase.storage.from('midias').list(registroId);
          if(files && files.length > 0) {
            for(const file of files) {
              const { data } = supabase.storage.from('midias').getPublicUrl(`${registroId}/${file.name}`);
              const ext = file.name.toLowerCase();
              let type = 'image';
              if(ext.includes('.mp4') || ext.includes('.webm') || ext.includes('.mov')) type = 'video';
              else if(ext.includes('.mp3') || ext.includes('.wav') || ext.includes('.ogg') || ext.includes('.m4a') || ext.includes('audio')) type = 'audio';
              mediaList.push({ url: data.publicUrl, type, name: file.name, source: 'supabase' });
            }
          }
        }
        
        if(active) setMedias(mediaList);
      } catch(e) {
        console.error('Erro ao carregar m√≠dias:', e);
      } finally {
        if(active) setLoading(false);
      }
    };
    
    loadMedias();
    
    return () => { 
      active = false; 
      objectUrls.forEach(url => URL.revokeObjectURL(url));
    };
  }, [registroId]);

  if(loading) return <div className="text-xs text-gray-400">Carregando m√≠dias...</div>;
  if(medias.length === 0) return <div className="text-xs text-gray-400">Nenhuma m√≠dia anexada</div>;

  return (
    <div className="space-y-2">
      {medias.map((media, idx) => (
        <div key={idx}>
          {media.type === 'audio' ? (
            <div className="bg-white p-2 rounded border border-gray-300">
              <div className="text-[10px] text-gray-500 mb-1 truncate max-w-[200px]">{media.name}</div>
              <audio controls src={media.url} className="w-full max-w-xs" />
            </div>
          ) : media.type === 'video' ? (
            <div className="bg-white p-2 rounded border border-gray-300">
              <div className="text-[10px] text-gray-500 mb-1 truncate max-w-[200px]">{media.name}</div>
              <video controls src={media.url} className="w-full max-w-sm rounded" />
            </div>
          ) : (
            <div className="relative cursor-pointer group inline-block" onClick={()=>onMediaClick(media.url, 'image')}>
              <img src={media.url} alt={media.name} className="w-24 h-24 object-cover rounded border-2 border-gray-300 hover:border-green-400 transition-colors" />
              <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-[8px] px-1 py-0.5 truncate">{media.name}</div>
            </div>
          )}
        </div>
      ))}
    </div>
  );
};

const PatientHistoryModal = ({registro, onClose, onUpdated}) => {
  const [medias, setMedias] = useState([]);
  const [replyTxt, setReplyTxt] = useState('');
  const [sending, setSending] = useState(false);
  const [localReplies, setLocalReplies] = useState(registro.replies || []);
  const [expandedMedia, setExpandedMedia] = useState(null);
  const [replyFiles, setReplyFiles] = useState([]);
  const [recordingAudio, setRecordingAudio] = useState(false);
  const recorderRef = useRef(null);
  const hasReachedLimit = (localReplies.length || 0) >= 5;

  useEffect(() => {
    setLocalReplies(registro.replies || []);
  }, [registro.replies, registro.registroId]);

  useEffect(() => {
    return () => {
      replyFiles.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
      if(recorderRef.current?.stream) recorderRef.current.stream.getTracks().forEach(t=>t.stop());
    };
  }, [replyFiles]);

  const addReplyFile = newFile => {
    if(newFile){
      const preview = URL.createObjectURL(newFile);
      setReplyFiles(prev => [...prev, {file: newFile, preview}]);
    }
  };

  const removeReplyFile = idx => {
    const removed = replyFiles[idx];
    if(removed.preview) URL.revokeObjectURL(removed.preview);
    setReplyFiles(prev => prev.filter((_,i) => i !== idx));
  };

  const handleReplyFilePick = e => {
    const picked = e.target.files[0];
    if(picked) addReplyFile(picked);
  };

  const startReplyAudioRecording = async () => {
    if(!navigator.mediaDevices?.getUserMedia) return alert('Microfone n√£o dispon√≠vel.');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type:'audio/webm' });
        const audioFile = new File([blob], `patient_audio_${Date.now()}.webm`, { type:'audio/webm' });
        addReplyFile(audioFile);
        stream.getTracks().forEach(t=>t.stop());
        recorderRef.current = null;
        setRecordingAudio(false);
      };
      recorder.start();
      recorderRef.current = { recorder, stream };
      setRecordingAudio(true);
    } catch(e) {
      alert('N√£o foi poss√≠vel gravar √°udio.');
    }
  };

  const stopReplyAudioRecording = () => {
    if(recorderRef.current?.recorder) recorderRef.current.recorder.stop();
    if(recorderRef.current?.stream) recorderRef.current.stream.getTracks().forEach(t=>t.stop());
    recorderRef.current = null;
    setRecordingAudio(false);
  };

  useEffect(() => {
    let urls = [];
    (async () => {
      const list = await db.midias.where('registroId').equals(registro.registroId).toArray();
      urls = list.map(item => ({...item, url: URL.createObjectURL(item.blob || item.blob)}));
      setMedias(urls);
    })();
    return () => { urls.forEach(m => m.url && URL.revokeObjectURL(m.url)); };
  }, [registro.registroId]);

  const handleReply = async () => {
    if(!replyTxt && replyFiles.length === 0) return alert('Digite uma mensagem ou anexe m√≠dia');
    if(hasReachedLimit) return alert('Limite de 5 intera√ß√µes atingido. Aguarde o profissional.');
    setSending(true);
    try {
      // Upload m√≠dias para Supabase se online
      const urls = [];
      if(navigator.onLine && replyFiles.length > 0) {
        for(const item of replyFiles) {
          const path = `${registro.registroId}/patient_${Date.now()}_${item.file.name}`;
          await supabase.storage.from('midias').upload(path, item.file);
          const {data} = supabase.storage.from('midias').getPublicUrl(path);
          urls.push(data.publicUrl);
        }
      }
      
      const reg = await db.registros.where('registroId').equals(registro.registroId).first();
      const newReply = { 
        from:'paciente', 
        text: replyTxt, 
        url: urls.length > 0 ? urls[0] : null,
        urls: urls,
        at: new Date().toISOString() 
      };
      const replies = (reg.replies || []).concat(newReply);
      await db.registros.where('registroId').equals(registro.registroId).modify({
        replies,
        updatedAt: new Date().toISOString(),
        notificationForPro: true,
        synced: 0
      });
      setLocalReplies(replies);
      setReplyTxt('');
      replyFiles.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
      setReplyFiles([]);
      syncManager();
      onUpdated?.();
    } finally {
      setSending(false);
    }
  };

  const lastProfReply = [...localReplies].filter(r => r.from === 'pro').slice(-1)[0];

  return (
    <>
      {expandedMedia && <MediaModal url={expandedMedia.url} type={expandedMedia.type} onClose={()=>setExpandedMedia(null)} />}
      <div className="modal-bg">
      <div className="bg-white rounded-2xl p-5 max-w-lg w-full max-h-[90vh] overflow-auto">
        <div className="flex justify-between items-center mb-3">
          <h3 className="text-xl font-bold">Detalhes do Registro</h3>
          <button className="btn-sec w-auto px-3 py-1 text-xs" onClick={onClose}>Fechar</button>
        </div>
        <div className="text-xs text-gray-500 mb-1">{formatDateISO(registro.createdAt)}</div>
        <div className="font-semibold text-lg mb-3">{registro.texto || 'Sem texto (apenas m√≠dia)'}</div>
        {lastProfReply && (
          <div className="bg-emerald-50 border border-emerald-100 text-emerald-900 rounded-xl p-3 mb-4">
            <div className="text-[10px] uppercase tracking-[0.2em] text-emerald-600 font-bold mb-1">Profissional respons√°vel</div>
            <div className="text-sm font-semibold">{lastProfReply.pro_name || 'Profissional'}</div>
            {lastProfReply.pro_ubs && <div className="text-xs opacity-80">{lastProfReply.pro_ubs}</div>}
          </div>
        )}
        {medias.length>0 && (
          <div className="space-y-3 mb-4">
            {medias.map(m => (
              <div key={m.id} className="bg-slate-50 p-3 rounded-xl">
                {m.type?.startsWith('image') && <img src={m.url} alt={m.name} className="w-full rounded" />}
                {m.type?.startsWith('video') && <video controls src={m.url} className="w-full rounded" />}
                {m.type?.startsWith('audio') && <audio controls src={m.url} className="w-full" />}
                {!m.type && <a href={m.url} download={m.name} className="text-blue-600 underline text-sm">{m.name}</a>}
              </div>
            ))}
          </div>
        )}
        <div className="section-title">Intera√ß√µes</div>
        <div className="space-y-2 mb-4">
          {localReplies.map((r, idx) => {
            const allUrls = r.urls && Array.isArray(r.urls) ? r.urls : (r.url ? [r.url] : []);
            return (
            <div key={idx} className={`p-3 rounded-xl ${r.from==='pro'?'bg-green-100 ml-auto text-right':'bg-slate-100'}`}>
              <div className="text-[10px] uppercase tracking-widest text-gray-500 mb-1">{r.from==='pro' ? (r.pro_name || 'PROFISSIONAL') : 'VOC√ä'}</div>
              <div>{r.text}</div>
              {allUrls.length > 0 && (
                <div className="mt-2 space-y-2">
                  {allUrls.map((url, i) => {
                    const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('video') || url.includes('.mov');
                    const isAudio = url.includes('.mp3') || url.includes('.wav') || url.includes('.ogg') || url.includes('.m4a') || url.includes('audio');
                    if(isAudio) {
                      return <audio key={i} controls src={url} className="w-full" />;
                    }
                    if(isVideo) {
                      return <video key={i} controls src={url} className="w-full max-w-sm rounded border-2 border-gray-300" />;
                    }
                    return (
                      <img key={i} src={url} alt="foto" className="max-w-[200px] rounded border-2 border-gray-300 cursor-pointer hover:border-green-400 transition-colors" onClick={()=>setExpandedMedia({url, type: 'image'})} />
                    );
                  })}
                </div>
              )}
              <div className="text-[10px] text-gray-400 mt-1">{formatDateISO(r.at)}</div>
            </div>
            );
          })}
          {localReplies.length===0 && <div className="text-xs text-gray-400">Nenhuma intera√ß√£o ainda.</div>}
        </div>
        {!hasReachedLimit && (
          <>
            <div className="section-title text-xs">Anexar M√≠dia (opcional)</div>
            <div className="media-row mb-3 flex-wrap">
              <label className="btn-media text-xs">üì∑ Foto<input type="file" accept="image/*" capture="environment" className="hidden-input" onChange={handleReplyFilePick}/></label>
              <label className="btn-media text-xs">üé• V√≠deo<input type="file" accept="video/*" capture="environment" className="hidden-input" onChange={handleReplyFilePick}/></label>
              <button type="button" className={`btn-media text-xs ${recordingAudio?'active':''}`} onClick={()=> recordingAudio ? stopReplyAudioRecording() : startReplyAudioRecording()}>{recordingAudio?'‚èπÔ∏è Parar':'üéôÔ∏è Gravar'}</button>
            </div>
            {replyFiles.length > 0 && (
              <div className="mb-3 space-y-2">
                {replyFiles.map((item, idx) => (
                  <div key={idx} className="bg-green-50 p-2 rounded border border-green-200 text-xs">
                    <div className="font-bold text-green-700">{item.file.name}</div>
                    {item.file.type.startsWith('audio') && <audio controls src={item.preview} className="w-full mt-1" />}
                    {item.file.type.startsWith('video') && <video controls src={item.preview} className="w-full mt-1 rounded" />}
                    {item.file.type.startsWith('image') && <img src={item.preview} alt="preview" className="w-full mt-1 rounded" />}
                    <button className="btn-sec mt-1 text-xs py-1" onClick={()=>removeReplyFile(idx)}>Remover</button>
                  </div>
                ))}
              </div>
            )}
          </>
        )}
        <textarea className="input-box" placeholder={hasReachedLimit ? 'Limite atingido' : 'Digite resposta ao profissional'} value={replyTxt} onChange={e=>setReplyTxt(e.target.value)} disabled={hasReachedLimit} />
        <button className="btn-primary" disabled={hasReachedLimit || sending} onClick={handleReply}>{hasReachedLimit?'LIMITE ATINGIDO':'RESPONDER'}</button>
      </div>
    </div>
    </>
  );
};

// -----------------------------------------------------------------------------
// COMPONENTES ISOLADOS (EVITAR ERRO DE HOOKS)
// -----------------------------------------------------------------------------

// LOGIN PACIENTE
const PatientLogin = ({onLogin, onRegister}) => {
  const [cpf, setCpf] = useState('');
  const [msg, setMsg] = useState('');
  const [checking, setChecking] = useState(false);
  const tryLogin = async () => {
    if(!cpf){ setMsg('Digite o CPF.'); return; }
    setChecking(true); setMsg('Verificando...');
    const clean = cpf.replace(/\D/g,'');
    const local = await db.perfil.where('cpf').equals(clean).first();
    if(local){
      setMsg('Perfil local encontrado. Entrando...');
      setTimeout(()=>onLogin(cpf),300);
    } else if(navigator.onLine){
      try {
        const { data } = await supabase
          .from('perfis')
          .select('patient_id, nome, cpf, regiao')
          .eq('cpf', clean)
          .maybeSingle(); // evita 406
        if(data){
          await db.perfil.add({ nome:data.nome, cpf:data.cpf, regiao:data.regiao||'', patientId:data.patient_id, synced:1 });
          setMsg('Perfil remoto sincronizado.');
          setTimeout(()=>onLogin(cpf),300);
        } else {
          setMsg('CPF n√£o encontrado. Cadastre-se.');
          setTimeout(()=>onRegister(cpf),800);
        }
      } catch {
        setMsg('Erro de conex√£o. Cadastre-se offline.');
        setTimeout(()=>onRegister(cpf),800);
      }
    } else {
      setMsg('Offline: CPF n√£o existe local. Cadastre-se.');
      setTimeout(()=>onRegister(cpf),800);
    }
    setChecking(false);
  };
  return (
    <div className="p-6 fade-in pt-20">
      <h2 className="text-2xl font-bold mb-2">Acesso Paciente</h2>
      <p className="text-gray-500 mb-6">Digite seu CPF para entrar</p>
      <input className="input-box" value={cpf} onChange={e=>setCpf(mascaraCPF(e.target.value))} placeholder="000.000.000-00" inputMode="numeric" />
      <button className="btn-primary mb-3" disabled={checking} onClick={tryLogin}>{checking?'VERIFICANDO...':'ENTRAR'}</button>
      {msg && <div className="text-xs font-bold text-center mb-3 text-green-700 bg-green-50 p-2 rounded-lg border border-green-200">{msg}</div>}
      <button className="btn-sec" onClick={()=>onRegister('')}>N√£o tenho cadastro</button>
    </div>
  );
};

// CADASTRO R√ÅPIDO PACIENTE (apenas campos b√°sicos)
const CadastroRapido = ({cpfInicial, onFinish, onCancel}) => {
  const [f, setF] = useState({
    nome:'', cpf:cpfInicial, nascimento:'', regiao:'', telefone:'', email:''
  });
  const salvar = async () => {
    if(!f.nome || !f.cpf || !f.nascimento || !f.regiao || !f.telefone) {
      return alert('Preencha todos os campos obrigat√≥rios (Nome, CPF, Data Nascimento, Regi√£o e Telefone).');
    }
    const clean = f.cpf.replace(/\D/g,'');
    const basicProfile = {
      nome: f.nome,
      cpf: clean,
      nascimento: f.nascimento,
      regiao: f.regiao,
      telefone: f.telefone,
      email: f.email || '',
      patientId: 'cpf-'+clean,
      synced: 0
    };
    const id = await db.perfil.add(basicProfile);
    const p = await db.perfil.get(id);
    localStorage.setItem('currentProfileId', p.patientId);
    syncManager();
    onFinish(p);
  };
  return (
    <div className="p-6 fade-in">
      <h2 className="text-2xl font-bold mb-4">Cadastro B√°sico</h2>
      <p className="text-gray-500 text-sm mb-6">Informe seus dados principais. O profissional de sa√∫de completar√° seu prontu√°rio.</p>
      
      <div className="section-title">Nome completo *</div>
      <input className="input-box" value={f.nome} onChange={e=>setF({...f,nome:e.target.value})} placeholder="Nome completo" />
      
      <div className="section-title">CPF *</div>
      <input className="input-box" value={f.cpf} onChange={e=>setF({...f,cpf:mascaraCPF(e.target.value)})} placeholder="000.000.000-00" inputMode="numeric" maxLength={14} />
      
      <div className="section-title">Data de Nascimento *</div>
      <input className="input-box" value={f.nascimento} onChange={e=>setF({...f,nascimento:mascaraData(e.target.value)})} placeholder="DD/MM/AAAA" inputMode="numeric" maxLength={10} />
      
      <div className="section-title">Regi√£o onde mora *</div>
      <select className="input-box" value={f.regiao} onChange={e=>setF({...f,regiao:e.target.value})}>
        <option value="">Escolha sua regi√£o...</option>
        {LISTA_REGIOES.map(r => <option key={r}>{r}</option>)}
      </select>
      
      <div className="section-title">Telefone *</div>
      <input className="input-box" value={f.telefone} onChange={e=>setF({...f,telefone:mascaraTelefone(e.target.value)})} placeholder="(91) 98765-4321" inputMode="tel" />
      
      <div className="section-title">Email (opcional)</div>
      <input className="input-box" value={f.email} onChange={e=>setF({...f,email:e.target.value})} placeholder="seuemail@exemplo.com" inputMode="email" />
      
      <button className="btn-primary mt-4" onClick={salvar}>SALVAR E ENTRAR</button>
      <button className="btn-sec mt-3" onClick={onCancel}>Voltar</button>
    </div>
  );
};

// NOVA MENSAGEM (CORRE√á√ÉO: Defini√ß√£o de 'tipo')
const NovaMensagem = ({onSend, onBack}) => {
  const [txt, setTxt] = useState('');
  const [files, setFiles] = useState([]);
  const [recordingAudio, setRecordingAudio] = useState(false);
  const recorderRef = useRef(null);

  useEffect(()=>()=>{
    files.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
    if(recorderRef.current?.stream){
      recorderRef.current.stream.getTracks().forEach(t=>t.stop());
    }
  },[files]);

  const addFile = newFile => {
    if(newFile){
      const preview = URL.createObjectURL(newFile);
      setFiles(prev => [...prev, {file: newFile, preview}]);
    }
  };

  const removeFile = idx => {
    const removed = files[idx];
    if(removed.preview) URL.revokeObjectURL(removed.preview);
    setFiles(prev => prev.filter((_,i) => i !== idx));
  };

  const handleFilePick = e => {
    const picked = e.target.files[0];
    if(picked) addFile(picked);
  };

  const startAudioRecording = async () => {
    if(!navigator.mediaDevices?.getUserMedia) return alert('Microfone n√£o suportado no dispositivo.');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];
      mediaRecorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type:'audio/webm' });
        const audioFile = new File([blob], `audio_${Date.now()}.webm`, { type:'audio/webm' });
        addFile(audioFile);
        stream.getTracks().forEach(t=>t.stop());
        recorderRef.current = null;
      };
      mediaRecorder.start();
      recorderRef.current = { recorder: mediaRecorder, stream };
      setRecordingAudio(true);
    } catch(e) {
      alert('N√£o foi poss√≠vel acessar o microfone.');
    }
  };

  const stopAudioRecording = () => {
    if(recorderRef.current?.recorder){
      recorderRef.current.recorder.stop();
    }
    if(recorderRef.current?.stream){
      recorderRef.current.stream.getTracks().forEach(t=>t.stop());
    }
    recorderRef.current = null;
    setRecordingAudio(false);
  };

  const handleSend = () => {
    const tipo = files.length > 0 ? (files[0].file.type.startsWith('image') ? 'foto' : files[0].file.type.startsWith('audio') ? 'audio' : 'video') : 'texto';
    if(!txt && files.length === 0) return alert('Escreva ou anexe algo.');
    onSend(txt, files.map(f => f.file), tipo);
    files.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
    setFiles([]);
    setTxt('');
  };

  return (
    <div className="p-5 h-screen flex flex-col bg-white fade-in">
      <div className="flex items-center gap-4 mb-4">
        <button onClick={onBack} className="text-2xl font-bold text-gray-400 px-2">‚Üê</button>
        <h2 className="text-xl font-bold text-slate-800">Novo Registro</h2>
      </div>
      <textarea 
        className="input-box flex-1 mb-6 text-lg p-4" 
        style={{resize:'none'}}
        placeholder="Descreva o que voc√™ est√° sentindo..." 
        value={txt} 
        onChange={e=>setTxt(e.target.value)} 
      />
      <div className="section-title">Anexar M√≠dia (Opcional)</div>
      <div className="media-row flex-wrap">
        <label className={`btn-media`}>
          üì∑ Foto (c√¢mera)
          <input type="file" accept="image/*" capture="environment" className="hidden-input" onChange={handleFilePick} />
        </label>
        <label className={`btn-media`}>
          üé• V√≠deo
          <input type="file" accept="video/*" capture="environment" className="hidden-input" onChange={handleFilePick} />
        </label>
        <button type="button" className={`btn-media ${recordingAudio?'active':''}`} onClick={()=> recordingAudio ? stopAudioRecording() : startAudioRecording()}>
          {recordingAudio ? '‚èπÔ∏è Parar grava√ß√£o' : 'üéôÔ∏è Gravar √°udio'}
          <span className="text-[10px] font-normal">(usa microfone do app)</span>
        </button>
      </div>
      {files.length > 0 && (
        <div className="mb-6 bg-green-50 p-3 rounded-xl border border-green-200 shadow-sm space-y-2">
          {files.map((item, idx) => (
            <div key={idx} className="bg-white p-2 rounded border border-green-300">
              <div className="font-bold text-green-700 truncate text-sm">{item.file.name}</div>
              {item.file.type.startsWith('audio') && <audio controls src={item.preview} className="w-full mt-2" />}
              {item.file.type.startsWith('video') && <video controls src={item.preview} className="w-full mt-2 rounded" />}
              {item.file.type.startsWith('image') && <img src={item.preview} alt="preview" className="w-full mt-2 rounded" />}
              <button className="btn-sec mt-2 text-xs" onClick={()=>removeFile(idx)}>Remover</button>
            </div>
          ))}
        </div>
      )}
      <button className="btn-primary" style={{padding:20, fontSize:18}} onClick={handleSend}>ENVIAR REGISTRO</button>
    </div>
  );
};

// DASHBOARD PACIENTE
const PatientDash = ({user, onLogout, onNewMsg}) => {
  const [hist, setHist] = useState([]);
  const [activeId, setActiveId] = useState(null);
  const patientKey = useMemo(() => user.patientId || 'local-'+user.id, [user]);
  const mountedRef = useRef(true);
  const activeRegistro = useMemo(() => hist.find(r => r.registroId === activeId) || null, [hist, activeId]);

  useEffect(() => {
    mountedRef.current = true;
    return () => { mountedRef.current = false; };
  }, []);

  const refreshHist = useCallback(async () => {
    const r = await db.registros.where('patientId').equals(patientKey).toArray();
    const sorted = r.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    if(mountedRef.current) setHist(sorted);
  }, [patientKey]);

  useEffect(() => {
    let intervalId;

    const pullRemote = async () => {
      if(!navigator.onLine) return;
      try {
        const { data, error } = await supabase
          .from('registros')
          .select('registro_id, patient_id, texto, tipo, status, replies_json, resposta, created_at, updated_at')
          .eq('patient_id', patientKey);
        if(error || !data) return;
        for (const item of data) {
          const existing = await db.registros.where('registroId').equals(item.registro_id).first();
          const base = {
            registroId: item.registro_id,
            patientId: item.patient_id || patientKey,
            deviceId: existing?.deviceId || 'remote',
            texto: item.texto || '',
            tipo: item.tipo || 'texto',
            status: item.status || 'pendente',
            replies: item.replies_json || [],
            resposta: item.resposta || '',
            createdAt: item.created_at || existing?.createdAt || new Date().toISOString(),
            updatedAt: item.updated_at || item.created_at || new Date().toISOString(),
            synced: 1
          };
          if(existing) await db.registros.update(existing.id, base);
          else await db.registros.add(base);
        }
      } catch (err) {
        console.error('Falha ao atualizar registros remotos', err);
      }
    };

    const bootstrap = async () => {
      await refreshHist();
      await pullRemote();
      await refreshHist();
    };

    bootstrap();
    intervalId = setInterval(async () => {
      await pullRemote();
      await refreshHist();
    }, 15000);

    return () => {
      if(intervalId) clearInterval(intervalId);
    };
  }, [patientKey, refreshHist]);

  return (
    <div className="p-5 fade-in min-h-screen">
        <div className="flex justify-between items-center mb-8">
            <div>
                <h1 className="text-2xl font-extrabold text-slate-800">Ol√°, {user.nome.split(' ')[0]}</h1>
            <div className="text-sm font-bold text-green-600">{user.regiao || 'Sem regi√£o'}</div>
            <div className="text-xs font-semibold text-slate-500">UBS: {user.ubs_referencia || 'N√£o informado'}</div>
            {user.acs_responsavel && <div className="text-xs font-semibold text-slate-500">Profissional/ACS: {user.acs_responsavel}</div>}
            </div>
            <button onClick={onLogout} className="bg-red-50 text-red-500 px-4 py-2 rounded-lg font-bold text-xs">SAIR</button>
        </div>
        <button className="btn-primary mb-8 py-5 shadow-lg" onClick={onNewMsg}><span>‚úö</span> NOVO REGISTRO</button>
        <div className="section-title">Seu Hist√≥rico</div>
        {hist.length===0 && <div className="text-center text-gray-400 mt-10">Nenhum registro ainda.</div>}
        {hist.map(r => {
          const lastPro = (r.replies || []).filter(rep => rep.from === 'pro').slice(-1)[0];
          return (
            <div key={r.id} className="card border-l-4 border-l-green-500 cursor-pointer" onClick={()=>setActiveId(r.registroId)}>
                  <div className="flex justify-between mb-3">
                      <span className="font-bold text-gray-400 text-xs tracking-wider">{formatDateISO(r.createdAt)}</span>
                      <span className={`badge ${r.status==='pendente'?'badge-pendente':'badge-ok'}`}>{r.status}</span>
                  </div>
              <div className="flex items-center gap-3">
                <RegistroThumb registroId={r.registroId} />
                <div className="flex-1">
                  <div className="text-lg font-medium text-slate-800 mb-2">{r.texto || 'M√≠dia enviada'}</div>
                  {lastPro && (
                    <div className="text-xs text-emerald-700 font-semibold">Atendido por {lastPro.pro_name || 'Profissional'}{lastPro.pro_ubs ? ` ‚Ä¢ ${lastPro.pro_ubs}` : ''}</div>
                  )}
                  {r.resposta && <div className="mt-3 bg-green-50 p-4 rounded-xl text-green-900 text-sm border border-green-100"><strong>Profissional:</strong> {r.resposta}</div>}
                </div>
              </div>
              </div>
          );
        })}
        {activeRegistro && <PatientHistoryModal registro={activeRegistro} onClose={()=>setActiveId(null)} onUpdated={refreshHist} />}
    </div>
  );
}

// AUTH PROFISSIONAL (CPF-based)
const ProAuth = ({onAuth, onBack}) => {
  const [step, setStep] = useState('cpf'); // 'cpf' | 'register'
  const [cpf, setCpf] = useState('');
  const [reg, setReg] = useState({nome:'', cpf:'', ubs:'', telefone:''});
  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState('');

  const checkCpf = async () => {
    if(!cpf) return alert('Digite o CPF');
    const clean = cpf.replace(/\D/g,'');
    if(clean.length !== 11) return alert('CPF inv√°lido');
    
    setLoading(true);
    try {
      const { data } = await supabase
        .from('profissionais')
        .select('*')
        .eq('cpf', clean)
        .maybeSingle();
      if(data){
        onAuth(data);
      } else {
        setReg(r=>({...r, cpf: mascaraCPF(clean)}));
        setStep('register');
        setMsg('CPF n√£o encontrado. Complete seu cadastro.');
      }
    } catch {
      setReg(r=>({...r, cpf: mascaraCPF(clean)}));
      setStep('register');
      setMsg('Offline ou erro. Cadastre-se.');
    }
    setLoading(false);
  };

  const register = async () => {
    if(!reg.nome || !reg.ubs || !reg.telefone) return alert('Preencha todos os campos');
    setLoading(true);
    try {
      const payload = { 
        nome: reg.nome,
        cpf: reg.cpf.replace(/\D/g,''),
        ubs: reg.ubs,
        telefone: reg.telefone
      };
      const { data, error } = await supabase.from('profissionais').insert(payload).select().maybeSingle();
      if(error){ alert('Erro ao cadastrar: ' + error.message); }
      else { alert('Cadastrado com sucesso!'); onAuth(data); }
    } catch(e) { 
      alert('Falha de rede: ' + e.message); 
    }
    setLoading(false);
  };

  if(loading) return <Loading text="Verificando..." />;

  if(step==='register') return (
    <div className="p-6 fade-in">
      <h2 className="text-2xl font-bold mb-4">Cadastro Profissional</h2>
      <p className="text-gray-500 mb-4">CPF <strong>{reg.cpf}</strong> n√£o encontrado</p>
      {msg && <div className="text-xs font-bold mb-4 text-blue-700 bg-blue-50 p-3 rounded-lg border border-blue-200">{msg}</div>}
      
      <div className="section-title">CPF (j√° preenchido)</div>
      <input className="input-box bg-gray-100" value={reg.cpf} disabled />
      
      <div className="section-title">Seu Nome</div>
      <select className="input-box" value={reg.nome} onChange={e=>setReg({...reg,nome:e.target.value})}>
        <option value="">Selecione seu nome...</option>
        {LISTA_ACS.map(n=><option key={n} value={n}>{n}</option>)}
      </select>
      
      <div className="section-title">UBS de Atua√ß√£o</div>
      <select className="input-box" value={reg.ubs} onChange={e=>setReg({...reg,ubs:e.target.value})}>
        <option value="">Selecione...</option>
        {LISTA_UBS.map(u=><option key={u} value={u}>{u}</option>)}
      </select>
      
      <div className="section-title">Telefone</div>
      <input className="input-box" value={reg.telefone} onChange={e=>setReg({...reg,telefone:mascaraTelefone(e.target.value)})} placeholder="(91) 98765-4321" inputMode="tel" />
      
      <button className="btn-primary mt-4" onClick={register}>CONCLUIR CADASTRO</button>
      <button className="btn-sec mt-3" onClick={()=>{setStep('cpf'); setCpf(''); setMsg('');}}>Voltar</button>
    </div>
  );

  return (
    <div className="p-6 fade-in pt-20">
      <h2 className="text-2xl font-bold mb-4">Acesso Profissional</h2>
      <p className="text-gray-500 mb-6">Digite seu CPF para entrar</p>
      <input 
        className="input-box text-center text-xl font-bold" 
        value={cpf} 
        onChange={e=>setCpf(mascaraCPF(e.target.value))} 
        placeholder="000.000.000-00" 
        inputMode="numeric" 
        maxLength={14}
      />
      <button className="btn-primary mt-4" onClick={checkCpf}>ACESSAR</button>
      <button className="btn-sec mt-3" onClick={onBack}>Voltar</button>
    </div>
  );
};

// FICHA COMPLETA DO PROFISSIONAL
const FichaMedica = ({initialData, onSave, onCancel}) => {
  const defaultFicha = {
    foto_url:'', nome:'', cpf:'', nascimento:'', genero:'', raca:'', endereco:'', telefone:'', escolaridade:'', profissao:'', mora_sozinho:'', regiao:'', ubs_referencia:'', acs_responsavel:'', hipertensao:'', diabetes:'', vicios:'', tempo_vicio:'', altura:'', peso_inicial:'', enxerga_bem:'', consulta_oftalmo:'', uso_medicacoes:'', atividade_fisica:'', freq_atividade:'', tipo_atividade:'', meta_peso:'', meta_glicemia:'', meta_pa_min:'', meta_pa_max:''
  };
  const [form, setForm] = useState({ ...defaultFicha, ...(initialData || {}) });
  const [fotoPreview, setFotoPreview] = useState(initialData?.foto_url || '');
  const [fotoFile, setFotoFile] = useState(null);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    const normalized = { ...defaultFicha, ...(initialData || {}) };
    if(normalized.cpf) normalized.cpf = mascaraCPF(normalized.cpf);
    if(normalized.telefone) normalized.telefone = mascaraTelefone(normalized.telefone);
    setForm(normalized);
    setFotoPreview(normalized.foto_url || '');
    setFotoFile(null);
  }, [initialData]);

  const hasBasicDataOnly = initialData && initialData.nome && initialData.cpf && !initialData.foto_url && !initialData.genero;
  const isNewPatient = !initialData || (!initialData.nome && !initialData.cpf);

  useEffect(() => {
    return () => {
      if(fotoPreview && fotoPreview.startsWith('blob:')) URL.revokeObjectURL(fotoPreview);
    };
  }, [fotoPreview]);

  const requiredLabel = label => (
    <div className="section-title flex items-center justify-between">
      <span>{label}</span>
      <span className="text-[10px] font-black text-rose-500 uppercase tracking-wide">Necess√°rio</span>
    </div>
  );

  const updateField = (key, value) => setForm(prev => ({ ...prev, [key]: value }));

  const handleFoto = e => {
    const file = e.target.files[0];
    if(fotoPreview && fotoPreview.startsWith('blob:')) URL.revokeObjectURL(fotoPreview);
    if(file){
      const url = URL.createObjectURL(file);
      setFotoFile(file);
      setFotoPreview(url);
    } else {
      setFotoFile(null);
      setFotoPreview(form.foto_url || '');
    }
  };

  const REQUIRED_KEYS = ['nome','cpf','nascimento','genero','raca','endereco','telefone','escolaridade','profissao','mora_sozinho','regiao','ubs_referencia','acs_responsavel','hipertensao','diabetes','vicios','tempo_vicio','peso_inicial','enxerga_bem','consulta_oftalmo','uso_medicacoes','atividade_fisica','freq_atividade','tipo_atividade','meta_peso','meta_glicemia','meta_pa_min','meta_pa_max'];

  const handleSubmit = async () => {
    for(const key of REQUIRED_KEYS){
      if(!form[key]){ alert('Preencha todos os campos obrigat√≥rios.'); return; }
    }
    if(!fotoPreview && !fotoFile && !form.foto_url){
      alert('Envie a foto de perfil.');
      return;
    }
    setSaving(true);
    try {
      let fotoFinal = form.foto_url || '';
      if(fotoFile) fotoFinal = await fileToDataUrl(fotoFile);
      await onSave({ ...form, foto_url: fotoFinal });
    } catch (err) {
      alert('Falha ao salvar prontu√°rio. Tente novamente.');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="fade-in pb-20">
      {hasBasicDataOnly && (
        <div className="bg-blue-50 border border-blue-200 text-blue-900 rounded-xl p-4 mb-6">
          <div className="text-sm font-bold mb-1">‚úì Paciente j√° cadastrado</div>
          <div className="text-xs">Complete o prontu√°rio com as informa√ß√µes de sa√∫de detalhadas.</div>
        </div>
      )}
      {isNewPatient && (
        <div className="bg-amber-50 border border-amber-200 text-amber-900 rounded-xl p-4 mb-6">
          <div className="text-sm font-bold mb-1">‚ö† Novo Prontu√°rio</div>
          <div className="text-xs">Este CPF n√£o foi encontrado. Cadastre um novo paciente com todas as informa√ß√µes.</div>
        </div>
      )}
      {requiredLabel('Foto de Perfil')}
      <div className="flex items-center gap-4 mb-6">
        <label className="thumb" style={{background:'#fff', overflow:'hidden', position:'relative', zIndex:1, flexShrink:0}}>
          {fotoPreview ? <img src={fotoPreview} alt="foto" style={{width:'100%',height:'100%',objectFit:'cover'}}/> : 'üì∑'}
          <input type="file" accept="image/*" className="hidden-input" onChange={handleFoto} />
        </label>
        <div className="text-xs text-gray-500 font-semibold">Escolha uma imagem n√≠tida do paciente.</div>
      </div>

      {requiredLabel('Nome completo')}
      <input className="input-box" value={form.nome} onChange={e=>updateField('nome', e.target.value)} placeholder="Nome completo" />

      {requiredLabel('CPF')}
      <input className="input-box" value={form.cpf} onChange={e=>updateField('cpf', mascaraCPF(e.target.value))} placeholder="000.000.000-00" inputMode="numeric" />

      {requiredLabel('Data de Nascimento')}
      <input className="input-box" value={form.nascimento} onChange={e=>updateField('nascimento', mascaraData(e.target.value))} placeholder="DD/MM/AAAA" inputMode="numeric" />

      {requiredLabel('G√™nero')}
      <select className="input-box" value={form.genero} onChange={e=>updateField('genero', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Masculino</option>
        <option>Feminino</option>
        <option>N√£o definido</option>
      </select>

      {requiredLabel('Ra√ßa/Cor')}
      <select className="input-box" value={form.raca} onChange={e=>updateField('raca', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Branco</option>
        <option>Pardo</option>
        <option>Negro</option>
        <option>Asi√°tico</option>
        <option>Ind√≠gena</option>
      </select>

      {requiredLabel('Endere√ßo')}
      <input className="input-box" value={form.endereco} onChange={e=>updateField('endereco', e.target.value)} placeholder="Rua das Mangueiras, n¬∫ 245, Bairro Nazar√©, Bel√©m ‚Äì PA" />

      {requiredLabel('Telefone')}
      <input className="input-box" value={form.telefone} onChange={e=>updateField('telefone', mascaraTelefone(e.target.value))} placeholder="(91) 98765-4321" inputMode="tel" />

      {requiredLabel('Grau de Instru√ß√£o')}
      <select className="input-box" value={form.escolaridade} onChange={e=>updateField('escolaridade', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sem instru√ß√£o</option>
        <option>Fundamental incompleto</option>
        <option>Fundamental completo</option>
        <option>Ensino m√©dio incompleto</option>
        <option>Ensino m√©dio completo</option>
        <option>Ensino superior incompleto</option>
        <option>Ensino superior completo</option>
      </select>

      {requiredLabel('Profiss√£o')}
      <input className="input-box" value={form.profissao} onChange={e=>updateField('profissao', e.target.value)} placeholder="Profiss√£o" />

      {requiredLabel('Mora sozinho?')}
      <select className="input-box" value={form.mora_sozinho} onChange={e=>updateField('mora_sozinho', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim, moro sozinho(a)</option>
        <option>N√£o, moro com familiares</option>
        <option>N√£o, moro com outras pessoas</option>
      </select>

      {requiredLabel('Regi√£o')}
      <select className="input-box" value={form.regiao} onChange={e=>updateField('regiao', e.target.value)}>
        <option value="">Escolha...</option>
        {LISTA_REGIOES.map(r => <option key={r}>{r}</option>)}
      </select>

      {requiredLabel('Unidade de Refer√™ncia')}
      <select className="input-box" value={form.ubs_referencia} onChange={e=>updateField('ubs_referencia', e.target.value)}>
        <option value="">Escolha...</option>
        {LISTA_UBS.map(u => <option key={u}>{u}</option>)}
      </select>

      {requiredLabel('Agente Comunit√°rio de Sa√∫de')}
      <select className="input-box" value={form.acs_responsavel} onChange={e=>updateField('acs_responsavel', e.target.value)}>
        <option value="">Escolha algo</option>
        {LISTA_ACS.map(a => <option key={a}>{a}</option>)}
      </select>

      {requiredLabel('Hipertens√£o')}
      <select className="input-box" value={form.hipertensao} onChange={e=>updateField('hipertensao', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('Diabetes')}
      <select className="input-box" value={form.diabetes} onChange={e=>updateField('diabetes', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('V√≠cios')}
      <select className="input-box" value={form.vicios} onChange={e=>updateField('vicios', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Tabagismo</option>
        <option>Etilismo</option>
        <option>Ex-etilista</option>
        <option>Ex-tabagista</option>
        <option>Uso de drogas il√≠citas</option>
        <option>Nenhum relato</option>
      </select>

      {requiredLabel('Tempo de V√≠cio')}
      <select className="input-box" value={form.tempo_vicio} onChange={e=>updateField('tempo_vicio', e.target.value)}>
        <option value="">Escolha...</option>
        <option>At√© 5 anos</option>
        <option>De 5 a 10 anos</option>
        <option>Mais de 10 anos</option>
      </select>

      <div className="section-title">Altura</div>
      <input className="input-box" value={form.altura} onChange={e=>updateField('altura', e.target.value)} placeholder="Ex.: 1,52 cm" />

      {requiredLabel('Peso Inicial')}
      <input className="input-box" value={form.peso_inicial} onChange={e=>updateField('peso_inicial', e.target.value)} placeholder="Ex.: 50,00" />

      {requiredLabel('Enxerga bem?')}
      <select className="input-box" value={form.enxerga_bem} onChange={e=>updateField('enxerga_bem', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('Consulta com oftalmologista')}
      <select className="input-box" value={form.consulta_oftalmo} onChange={e=>updateField('consulta_oftalmo', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('Faz uso de medica√ß√µes?')}
      <select className="input-box" value={form.uso_medicacoes} onChange={e=>updateField('uso_medicacoes', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('Faz Atividade F√≠sica?')}
      <select className="input-box" value={form.atividade_fisica} onChange={e=>updateField('atividade_fisica', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Sim</option>
        <option>N√£o</option>
      </select>

      {requiredLabel('Frequ√™ncia da Atividade F√≠sica')}
      <select className="input-box" value={form.freq_atividade} onChange={e=>updateField('freq_atividade', e.target.value)}>
        <option value="">Escolha...</option>
        <option>1x semana</option>
        <option>2-3x semana</option>
        <option>4-5x semana</option>
        <option>Di√°rio</option>
        <option>Nunca</option>
      </select>

      {requiredLabel('Que tipo de Atividade F√≠sica?')}
      <select className="input-box" value={form.tipo_atividade} onChange={e=>updateField('tipo_atividade', e.target.value)}>
        <option value="">Escolha...</option>
        <option>Caminhada</option>
        <option>Corrida</option>
        <option>Muscula√ß√£o</option>
        <option>Dan√ßa</option>
        <option>Esportes</option>
        <option>Outra</option>
      </select>

      {requiredLabel('Meta de Peso')}
      <input className="input-box" value={form.meta_peso} onChange={e=>updateField('meta_peso', e.target.value)} placeholder="Ex.: 60" />

      {requiredLabel('Meta Glicemia')}
      <input className="input-box" value={form.meta_glicemia} onChange={e=>updateField('meta_glicemia', e.target.value)} placeholder="Ex.: 110" />

      {requiredLabel('Meta PA M√≠nima')}
      <input className="input-box" value={form.meta_pa_min} onChange={e=>updateField('meta_pa_min', e.target.value)} placeholder="Ex.: 110" />

      {requiredLabel('Meta PA M√°xima')}
      <input className="input-box" value={form.meta_pa_max} onChange={e=>updateField('meta_pa_max', e.target.value)} placeholder="Ex.: 140" />

      <button className="btn-primary mt-4" onClick={handleSubmit} disabled={saving}>{saving ? 'SALVANDO...' : 'SALVAR PRONTU√ÅRIO'}</button>
      <button className="btn-sec mt-3" onClick={onCancel}>Cancelar</button>
    </div>
  );
};

// DASHBOARD DO PROFISSIONAL
const ProDash = ({user, onLogout}) => {
  const [mode, setMode] = useState('menu'); 
  const [list, setList] = useState([]);
  const [search, setSearch] = useState('');
  const [formData, setFormData] = useState({});
  const [activeChat, setActiveChat] = useState(null);
  const [reply, setReply] = useState('');
  const [files, setFiles] = useState([]);
  const [recordingAudio, setRecordingAudio] = useState(false);
  const recorderRef = useRef(null);
  const [loadingList, setLoadingList] = useState(false);
  const [newPatientCount, setNewPatientCount] = useState(0);
  const [pendingCount, setPendingCount] = useState(0);
  const [expandedMedia, setExpandedMedia] = useState(null);

  const addFile = newFile => {
    if(newFile){
      const preview = URL.createObjectURL(newFile);
      setFiles(prev => [...prev, {file: newFile, preview}]);
    }
  };

  const removeFile = idx => {
    const removed = files[idx];
    if(removed.preview) URL.revokeObjectURL(removed.preview);
    setFiles(prev => prev.filter((_,i) => i !== idx));
  };

  const loadList = async () => {
    setLoadingList(true);
    try {
      const { data: regs, error: regErr } = await supabase.from('registros').select('*').order('updated_at', {ascending:false});
      if(regErr) throw regErr;
      const { data: perfs, error: perfErr } = await supabase.from('perfis').select('*');
      if(perfErr) throw perfErr;
      const map = {}; perfs?.forEach(p => map[p.patient_id] = p);
      
      // Buscar primeira m√≠dia de cada registro
      const enriched = await Promise.all((regs || []).map(async r => {
        let firstMediaUrl = null;
        let mediaType = null;
        
        // Buscar no Storage Supabase
        const { data: files } = await supabase.storage.from('midias').list(r.registro_id);
        if(files && files.length > 0) {
          const first = files[0];
          const { data } = supabase.storage.from('midias').getPublicUrl(`${r.registro_id}/${first.name}`);
          firstMediaUrl = data.publicUrl;
          // Detectar tipo pela extens√£o
          const ext = first.name.toLowerCase();
          if(ext.includes('.jpg') || ext.includes('.jpeg') || ext.includes('.png') || ext.includes('.gif')) mediaType = 'image';
          else if(ext.includes('.mp4') || ext.includes('.webm') || ext.includes('.mov')) mediaType = 'video';
          else if(ext.includes('.mp3') || ext.includes('.wav') || ext.includes('.ogg') || ext.includes('.m4a')) mediaType = 'audio';
        }
        
        return { ...r, perfil: map[r.patient_id] || {}, replies: r.replies_json || [], firstMediaUrl, mediaType };
      }));
      
      setList(enriched);
      setMode('list');
    } catch (err) {
      alert('Falha ao atualizar atendimentos. Verifique a conex√£o.');
    } finally {
      setLoadingList(false);
    }
  };

  const checkNewPatients = async () => {
    try {
      const { data: perfs } = await supabase.from('perfis').select('cpf, nome, foto_url, genero, hipertensao');
      const incomplete = (perfs || []).filter(p => p.nome && p.cpf && (!p.foto_url || !p.genero || !p.hipertensao));
      setNewPatientCount(incomplete.length);
    } catch {
      setNewPatientCount(0);
    }
  };

  const checkPendingCount = async () => {
    try {
      const { data: regs } = await supabase.from('registros').select('status');
      const pending = (regs || []).filter(r => r.status === 'pendente' || r.status === 'em_analise');
      setPendingCount(pending.length);
    } catch {
      setPendingCount(0);
    }
  };

  const showNewPatients = async () => {
    try {
      const { data: perfs } = await supabase.from('perfis').select('*');
      const incomplete = (perfs || []).filter(p => p.nome && p.cpf && (!p.foto_url || !p.genero || !p.hipertensao));
      if(incomplete.length === 0){
        alert('Nenhum cadastro b√°sico pendente.');
        return;
      }
      // Mostra lista de pacientes incompletos
      setList(incomplete.map(p => ({
        registro_id: 'pending-'+p.patient_id,
        patient_id: p.patient_id,
        perfil: p,
        status: 'novo_cadastro',
        texto: 'Cadastro b√°sico aguardando prontu√°rio',
        updated_at: p.created_at || new Date().toISOString(),
        replies: []
      })));
      setMode('new_patients');
    } catch {
      alert('Erro ao buscar novos cadastros.');
    }
  };

  const handleSearch = async () => {
    if(!search) return alert('Digite CPF');
    const clean = search.replace(/\D/g,'');
    if(!navigator.onLine){
      const local = await db.perfil.where('cpf').equals(clean).first();
      if(local){ 
        setFormData({...local, cpf:mascaraCPF(local.cpf)}); 
      }
      else { 
        setFormData({cpf:mascaraCPF(clean)}); 
      }
      setMode('form'); return;
    }
    try {
      const { data } = await supabase.from('perfis').select('*').eq('cpf', clean).maybeSingle();
      if(data){ 
        setFormData({...data, cpf:mascaraCPF(data.cpf)}); 
      }
      else { 
        setFormData({cpf:mascaraCPF(clean)}); 
      }
      setMode('form');
    } catch {
      setFormData({cpf:mascaraCPF(clean)});
      setMode('form');
    }
  };

  const saveForm = async (f) => {
    const clean = f.cpf.replace(/\D/g,'');
    const payload = { ...f, patient_id: 'cpf-'+clean, cpf: clean, updated_at: new Date().toISOString() };
    await supabase.from('perfis').upsert(payload, { onConflict: 'patient_id' });
    alert('Salvo!'); setMode('menu'); setSearch('');
  };

  const sendReply = async () => {
    if(!reply && files.length === 0) return;
    if((activeChat.replies?.length || 0) >= 5) return alert('Limite de 5 intera√ß√µes atingido neste registro.');
    
    const urls = [];
    for(const item of files) {
      const path = `${activeChat.registro_id}/pro_${Date.now()}_${item.file.name}`;
      await supabase.storage.from('midias').upload(path, item.file);
      const {data} = supabase.storage.from('midias').getPublicUrl(path);
      urls.push(data.publicUrl);
    }
    
    const newR = { 
      from:'pro', 
      pro_name:user.nome, 
      pro_ubs:user.ubs || '', 
      pro_cpf:user.cpf || '', 
      text:reply, 
      url: urls.length > 0 ? urls[0] : null,
      urls: urls,
      at:new Date().toISOString() 
    };
    const updated = [...activeChat.replies, newR];
    const resumo = reply || (files.length > 0 ? 'M√≠dia enviada pelo profissional' : 'Nova intera√ß√£o');
    await supabase.from('registros').update({ status:'respondido', updated_at:new Date().toISOString(), replies_json:updated, resposta:resumo }).eq('id', activeChat.id);
    alert('Enviado'); setReply(''); 
    files.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
    setFiles([]);
    setActiveChat(prev=>prev?{...prev,replies:updated,resposta:resumo}:prev); 
    loadList();
  };

  const pickFile = e => {
    const f = e.target.files[0];
    if(f) addFile(f);
  };

  const startAudioRecordingPro = async () => {
    if(!navigator.mediaDevices?.getUserMedia) return alert('Microfone indispon√≠vel.');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = evt => { if(evt.data.size) chunks.push(evt.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type:'audio/webm' });
        const audioFile = new File([blob], `pro_audio_${Date.now()}.webm`, { type:'audio/webm' });
        addFile(audioFile);
        stream.getTracks().forEach(t=>t.stop());
        recorderRef.current = null;
        setRecordingAudio(false);
      };
      recorder.start();
      recorderRef.current = { recorder, stream };
      setRecordingAudio(true);
    } catch(e) {
      alert('N√£o foi poss√≠vel iniciar a grava√ß√£o.');
    }
  };

  const stopAudioRecordingPro = () => {
    if(recorderRef.current?.recorder) recorderRef.current.recorder.stop();
    if(recorderRef.current?.stream){
      recorderRef.current.stream.getTracks().forEach(t=>t.stop());
    }
    recorderRef.current = null;
    setRecordingAudio(false);
  };

  useEffect(()=>{
    return () => {
      files.forEach(f => { if(f.preview) URL.revokeObjectURL(f.preview); });
      if(recorderRef.current?.stream){
        recorderRef.current.stream.getTracks().forEach(t=>t.stop());
      }
    };
  }, [files]);

  useEffect(() => {
    if(mode === 'menu'){
      checkNewPatients();
      checkPendingCount();
      const interval = setInterval(() => {
        checkNewPatients();
        checkPendingCount();
      }, 30000);
      return () => clearInterval(interval);
    }
  }, [mode]);

  // VIEW: MENU
  if(mode === 'menu') {
    return (
    <div className="p-6 fade-in">
      <div className="flex justify-between items-center mb-8">
        <div><h2 className="text-xl font-bold">{user.nome.split(' ')[0]}</h2><p className="text-gray-500 text-sm">{user.ubs}</p></div>
        <button onClick={onLogout} className="text-red-500 font-bold text-sm">SAIR</button>
      </div>
      <div className="grid gap-4">
        <button className="big-btn" onClick={loadList}>
          <div className="big-btn-icon">üìÇ</div>
          <div className="font-bold text-lg">Painel de Atendimentos {pendingCount > 0 && `(${pendingCount})`}</div>
          {pendingCount > 0 && <div className="text-xs text-gray-600">Pacientes aguardando atendimento</div>}
        </button>
        {newPatientCount > 0 && (
          <button className="big-btn" style={{borderColor:'#f59e0b', background:'#fffbeb'}} onClick={showNewPatients}>
            <div className="big-btn-icon" style={{background:'#fef3c7'}}>üÜï</div>
            <div className="font-bold text-lg text-amber-900">Novos Cadastros ({newPatientCount})</div>
            <div className="text-xs text-amber-700">Pacientes aguardando prontu√°rio completo</div>
          </button>
        )}
        <div className="card border-2 border-slate-200 mt-4">
          <div className="text-center font-bold mb-4">Gerir Prontu√°rio</div>
          <div className="flex gap-2">
            <input className="input-box mb-0" placeholder="Buscar CPF..." value={search} onChange={e=>setSearch(mascaraCPF(e.target.value))} />
            <button className="btn-primary w-auto px-6" onClick={handleSearch}>üîç</button>
          </div>
        </div>
      </div>
    </div>
    );
  }

  // VIEW: FORM
  if(mode === 'form') return (
    <div className="p-4 fade-in">
      <div className="flex items-center gap-3 mb-4"><button onClick={()=>setMode('menu')} className="text-2xl font-bold text-gray-400">‚Üê</button><h2 className="text-xl font-bold">Ficha M√©dica</h2></div>
      <div className="card"><FichaMedica initialData={formData} onSave={saveForm} onCancel={()=>setMode('menu')} /></div>
    </div>
  );

  // VIEW: NOVOS CADASTROS
  if(mode === 'new_patients') {
    return (
      <div className="p-4 fade-in">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-amber-900">Novos Cadastros ({list.length})</h2>
          <button onClick={()=>setMode('menu')} className="btn-sec w-auto">Menu</button>
        </div>
        <p className="text-sm text-gray-600 mb-4">Pacientes com cadastro b√°sico aguardando prontu√°rio completo:</p>
        {list.map(item => {
          const p = item.perfil;
          const cpfFormat = p.cpf ? mascaraCPF(p.cpf) : '---';
          const idadeLabel = p.nascimento ? calcAge(p.nascimento) : 'Idade n√£o informada';
          return (
            <div key={item.registro_id} onClick={()=>{ setFormData({...p, cpf:cpfFormat}); setMode('form'); }} className="card cursor-pointer hover:bg-amber-50 transition-colors border-l-4 border-l-amber-500">
              <div className="flex justify-between mb-2">
                <span className="badge" style={{background:'#fef3c7', color:'#92400e'}}>PENDENTE</span>
                <span className="text-xs text-gray-400">{formatDateISO(item.updated_at)}</span>
              </div>
              <div className="font-bold text-lg">{p.nome || 'Sem nome'}</div>
              <div className="text-sm text-gray-500">CPF: {cpfFormat}</div>
              <div className="text-xs text-gray-400">{p.regiao || 'Regi√£o n√£o informada'}{idadeLabel ? ` ‚Ä¢ ${idadeLabel}` : ''}</div>
              <div className="text-xs text-amber-700 font-semibold mt-2">üìã Clique para completar prontu√°rio</div>
            </div>
          );
        })}
      </div>
    );
  }

  // VIEW: LISTA
  if(mode === 'list') {
    if(activeChat) {
      const perfil = activeChat.perfil || {};
      const cpfFormatado = perfil.cpf ? mascaraCPF(perfil.cpf) : '---';
      const idadeStr = perfil.nascimento ? calcAge(perfil.nascimento) : 'Idade n√£o informada';
      return (
      <>
      {expandedMedia && <MediaModal url={expandedMedia.url} type={expandedMedia.type} onClose={()=>setExpandedMedia(null)} />}
      <div className="p-4 fade-in pb-40">
        <button onClick={()=>setActiveChat(null)} className="mb-4 text-gray-500 font-bold">‚Üê VOLTAR</button>
        <div className="card">
          <div className="flex justify-between">
            <div>
              <div className="font-bold text-lg">{perfil.nome || 'Paciente sem nome'}</div>
              <div className="text-sm text-gray-500">CPF: {cpfFormatado}</div>
              <div className="text-xs text-gray-500">{idadeStr}{perfil.regiao ? ` ‚Ä¢ ${perfil.regiao}` : ''}</div>
            </div>
            <button onClick={()=>{setFormData(activeChat.perfil); setMode('form')}} className="btn-sec w-auto text-xs px-3 py-1 h-8">FICHA</button>
          </div>
                
                {/* Mensagem inicial */}
                {activeChat.texto && (
                  <div className="bg-slate-50 p-3 rounded-lg mt-4">
                    <div className="text-xs font-bold text-gray-500 mb-1">MENSAGEM INICIAL</div>
                    <div className="text-base">{activeChat.texto}</div>
                  </div>
                )}
                
                {/* M√çDIAS DO REGISTRO INICIAL - LAYOUT BONITO */}
                {activeChat.registro_id && (
                  <div className="mt-4">
                    <div className="text-xs uppercase tracking-widest text-gray-500 mb-2 font-bold">üìé Anexos do Paciente</div>
                    <MediasDoRegistro registroId={activeChat.registro_id} onMediaClick={(url, type)=>setExpandedMedia({url, type})} />
                  </div>
                )}
                
                {/* HIST√ìRICO DE RESPOSTAS */}
                {activeChat.replies && activeChat.replies.length > 0 && (
                  <div className="mt-6">
                    <div className="text-xs uppercase tracking-widest text-gray-500 mb-3 font-bold">üí¨ Hist√≥rico de Conversa</div>
                    <div className="space-y-4">
                      {activeChat.replies.map((r,i)=>{
                        const allUrls = r.urls && Array.isArray(r.urls) ? r.urls : (r.url ? [r.url] : []);
                        const isPro = r.from === 'pro';
                        return (
                          <div key={i} className={`flex ${isPro ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm ${isPro ? 'bg-green-100 border border-green-200' : 'bg-white border border-gray-200'}`}>
                              <div className="text-xs font-bold mb-2" style={{color: isPro ? '#166534' : '#64748b'}}>
                                {isPro ? 'ü©∫ Voc√™ (Profissional)' : 'üë§ Paciente'}
                              </div>
                              {r.text && <div className="text-base mb-2">{r.text}</div>}
                              
                              {/* M√çDIAS COM PLAYERS BONITOS */}
                              {allUrls.length > 0 && (
                                <div className="mt-3 space-y-3">
                                  {allUrls.map((url, idx) => {
                                    const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('video') || url.includes('.mov');
                                    const isAudio = url.includes('.mp3') || url.includes('.wav') || url.includes('.ogg') || url.includes('.m4a') || url.includes('audio');
                                    
                                    if(isAudio) {
                                      return (
                                        <div key={idx} className="bg-white rounded-lg p-3 border">
                                          <div className="text-xs text-gray-500 mb-2 font-bold">üéµ √Åudio</div>
                                          <audio controls src={url} className="w-full" style={{height: '40px'}} />
                                        </div>
                                      );
                                    }
                                    
                                    if(isVideo) {
                                      return (
                                        <div key={idx} className="bg-white rounded-lg overflow-hidden border-2 border-gray-300">
                                          <div className="bg-gray-50 px-3 py-2 text-xs text-gray-600 font-bold border-b">üé• V√≠deo</div>
                                          <video controls src={url} className="w-full" style={{maxHeight: '400px'}} />
                                        </div>
                                      );
                                    }
                                    
                                    return (
                                      <img 
                                        key={idx} 
                                        src={url} 
                                        alt="foto" 
                                        className="w-full rounded-lg border-2 border-gray-300 cursor-pointer hover:border-green-500 transition-all shadow-sm" 
                                        onClick={()=>setExpandedMedia({url, type: 'image'})}
                                        style={{maxWidth: '100%'}}
                                      />
                                    );
                                  })}
                                </div>
                              )}
                              
                              <div className="text-xs text-gray-400 mt-2">{formatDateISO(r.timestamp || new Date().toISOString())}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
            </div>
            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t rounded-t-3xl shadow-2xl">
                <textarea className="input-box h-20" placeholder="Resposta..." value={reply} onChange={e=>setReply(e.target.value)} />
                <div className="media-row mt-2">
                  <label className="btn-media">üì∑ Foto<input type="file" accept="image/*" capture="environment" className="hidden-input" onChange={pickFile}/></label>
                  <label className="btn-media">üé• V√≠deo<input type="file" accept="video/*" capture="environment" className="hidden-input" onChange={pickFile}/></label>
                  <button type="button" className={`btn-media ${recordingAudio?'active':''}`} onClick={()=> recordingAudio ? stopAudioRecordingPro() : startAudioRecordingPro()}>{recordingAudio?'‚èπÔ∏è Parar':'üéôÔ∏è Gravar'}</button>
                </div>
                {files.length > 0 && (
                  <div className="mb-2 space-y-2">
                    {files.map((item, idx) => (
                      <div key={idx} className="text-xs bg-green-50 p-2 rounded border border-green-200">
                        <div className="font-bold text-green-600">{item.file.name}</div>
                        {item.file.type.startsWith('audio') && <audio controls className="w-full mt-1" src={item.preview} />}
                        {item.file.type.startsWith('video') && <video controls className="w-full mt-1" src={item.preview} />}
                        {item.file.type.startsWith('image') && <img src={item.preview} alt="preview" className="w-full mt-1 rounded" />}
                        <button className="btn-sec mt-1 text-xs py-1" onClick={()=>removeFile(idx)}>Remover</button>
                      </div>
                    ))}
                  </div>
                )}
                <button className="btn-primary" onClick={sendReply}>ENVIAR</button>
            </div>
        </div>
        </>
          );
          }
    return (
        <div className="p-4 fade-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Atendimentos</h2>
              <div className="flex gap-2">
                <button onClick={()=>setMode('menu')} className="btn-sec w-auto">Menu</button>
                <button onClick={loadList} className="btn-primary w-auto px-5" style={{width:'auto'}} disabled={loadingList}>{loadingList ? 'Atualizando...' : 'Atualizar'}</button>
              </div>
            </div>
            {list.map(r => {
              const cpfFormat = r.perfil?.cpf ? mascaraCPF(r.perfil.cpf) : '---';
              const idadeLabel = r.perfil?.nascimento ? calcAge(r.perfil.nascimento) : '';
              const regiaoLabel = r.perfil?.regiao || 'Regi√£o n√£o informada';
              return (
                <div key={r.registro_id} onClick={()=>setActiveChat(r)} className="card cursor-pointer hover:bg-slate-50 transition-colors">
                  <div className="flex gap-3">
                    {r.firstMediaUrl && (
                      <div className="flex-shrink-0 w-20 h-20 relative" onClick={(e)=>{e.stopPropagation(); setExpandedMedia({url: r.firstMediaUrl, type: r.mediaType})}}>
                        {r.mediaType === 'video' && (
                          <div className="relative w-full h-full">
                            <video src={r.firstMediaUrl} className="w-full h-full object-cover rounded border-2 border-gray-200" />
                            <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 rounded">
                              <span className="text-white text-2xl">‚ñ∂</span>
                            </div>
                          </div>
                        )}
                        {r.mediaType === 'image' && (
                          <img src={r.firstMediaUrl} alt="thumb" className="w-full h-full object-cover rounded border-2 border-gray-200 hover:border-green-400 transition-colors" />
                        )}
                        {r.mediaType === 'audio' && (
                          <div className="w-full h-full flex items-center justify-center bg-gray-100 rounded border-2 border-gray-200">
                            <span className="text-4xl">üéµ</span>
                          </div>
                        )}
                      </div>
                    )}
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between mb-1">
                        <div className="font-bold text-lg truncate">{r.perfil?.nome || 'Paciente'}</div>
                        <span className="text-xs text-gray-400 flex-shrink-0 ml-2">{formatDateISO(r.updated_at)}</span>
                      </div>
                      <div className="text-sm text-gray-500">CPF: {cpfFormat}</div>
                      <div className="text-xs text-gray-400">{regiaoLabel}{idadeLabel ? ` ‚Ä¢ ${idadeLabel}` : ''}</div>
                      <div className="text-sm text-gray-600 truncate mt-1">{r.texto || 'M√≠dia enviada'}</div>
                    </div>
                  </div>
                </div>
              );
            })}
        </div>
    );
  }
};

// --- APP ROOT ---
const App = () => {
  const [route, setRoute] = useState('welcome');
  const [user, setUser] = useState(null);
  const [tempCpf, setTempCpf] = useState('');
  const [online, setOnline] = useState(navigator.onLine);
  useEffect(()=>{
    const f = ()=>setOnline(navigator.onLine);
    window.addEventListener('online', f); window.addEventListener('offline', f);
    return ()=>{ window.removeEventListener('online', f); window.removeEventListener('offline', f); };
  }, []);

  // Auto Login Paciente
  useEffect(()=>{ 
    const pid = localStorage.getItem('currentProfileId');
    if(pid) {
      db.perfil.where('patientId').equals(pid).first().then(p => {
        if(p) { setUser(p); setRoute('patient_dash'); syncManager(); }
      });
    }
  }, []);

  const loginPatient = async (cpf) => {
    const clean = cpf.replace(/\D/g,'');
    const p = await db.perfil.where('cpf').equals(clean).first();
    if(p){ localStorage.setItem('currentProfileId', p.patientId); setUser(p); setRoute('patient_dash'); return; }
    // Direto para cadastro com CPF preenchido
    setTempCpf(mascaraCPF(clean));
    setRoute('patient_reg');
  };

  const loginPro = (data) => { setUser(data); setRoute('pro_dash'); };

  const sendReg = async (txt, filesArray, type) => {
    try {
      const pid = user.patientId || 'local-'+user.id;
      const rid = uuidv4(); const now = new Date().toISOString();
      
      // Salva registro
      await db.registros.add({ registroId:rid, patientId:pid, deviceId:'dev', texto:txt, tipo:type, status:'pendente', createdAt:now, updatedAt:now, replies:[], synced:0 });
      
      // Salva TODOS os arquivos
      if(filesArray && filesArray.length > 0) {
        for(const file of filesArray) {
          await db.midias.add({ registroId:rid, name:file.name, type:file.type, blob:file, synced:0 });
        }
      }
      
      syncManager(); alert('Salvo!'); setRoute('patient_dash');
    } catch(e) { alert(e); }
  };

  const OfflineBanner = () => !online && <div className="fixed top-0 left-0 right-0 bg-red-600 text-white text-center text-xs py-2 z-50 font-bold">Modo Offline: dados ser√£o salvos localmente</div>;

  if(route === 'welcome') return (
    <div className="flex flex-col items-center justify-center min-h-screen p-6 fade-in text-center">
      <OfflineBanner />
      <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-5xl shadow-lg">üåø</div>
      <h1 className="text-3xl font-extrabold text-green-900 mb-2">TECENDO SA√öDE</h1>
      <p className="text-gray-500 mb-10 text-lg">Baixo Amazonas e Tapaj√≥s</p>
      <button className="btn-primary mb-4 py-4 text-lg" onClick={()=>setRoute('login_patient')}>SOU PACIENTE</button>
      <button className="text-green-700 font-bold text-sm mt-4 p-4" onClick={()=>setRoute('login_pro')}>√ÅREA PROFISSIONAL</button>
    </div>
  );

  if(route === 'login_patient') return <><OfflineBanner /><PatientLogin onLogin={loginPatient} onRegister={(cpf)=>{setTempCpf(cpf||''); setRoute('patient_reg');}} /></>;
  
  if(route === 'patient_reg') return <><OfflineBanner /><CadastroRapido cpfInicial={tempCpf} onFinish={(p)=>{setUser(p); setRoute('patient_dash');}} onCancel={()=>setRoute('welcome')} /></>;
  
  if(route === 'patient_dash') return <><OfflineBanner /><PatientDash user={user} onNewMsg={()=>setRoute('patient_new')} onLogout={()=>{localStorage.clear(); window.location.reload()}} /></>;
  
  // CORRE√á√ÉO DO ENVIO: Passa 'tipo' corretamente
  if(route === 'patient_new') return <><OfflineBanner /><NovaMensagem onBack={()=>setRoute('patient_dash')} onSend={sendReg} /></>;

  if(route === 'login_pro') return <><OfflineBanner /><ProAuth onAuth={loginPro} onBack={()=>setRoute('welcome')} /></>;
  
  if(route === 'pro_dash') return <><OfflineBanner /><ProDash user={user} onLogout={()=>{setUser(null); setRoute('welcome')}} /></>;

  return <Loading text="Carregando..." />;
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>